<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>AppRTC服务器搭建 | jwcqc个人笔记</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">AppRTC服务器搭建</h1><a id="logo" href="/.">jwcqc个人笔记</a><p class="description">年华虚度 空有一身疲惫</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">AppRTC服务器搭建</h1><div class="post-meta">Sep 26, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>WebRTC，是Web Real-Time Communication的缩写，是谷歌2010年以6820万美元收购Global IP Solutions公司而获得的一项技术，于2011年5月开放了工程的源代码，在行业内得到了广泛的支持和应用，成为下一代视频通话的标准。</p>
<p>这篇文章要搭建的，是基于webrtc的apprtc示例，GitHub地址：<a href="https://github.com/webrtc/apprtc" target="_blank" rel="external">https://github.com/webrtc/apprtc</a> 里面有讲一些安装步骤，但是不够仔细，楼主试了几天，填了很多坑之后，终于将环境搭起来了，过程比较艰辛，要安装的东西和注意的细节太多，值得写篇文章来记录一下~</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="了解原理"><a href="#了解原理" class="headerlink" title="了解原理"></a>了解原理</h3><p>需要搭建三个服务器，分别是房间服务器、信令服务器以及打洞服务器</p>
<ul>
<li><p>通话的房间服务器(Room Server)</p>
<p>  房间服务器是用来创建和管理通话会话的状态维护,是双方通话还是多方通话,加入与离开房间等等,我们暂时沿用Google部署在GAE平台上的AppRTC这个房间服务器实现,该GAE App的源码可以在github.com上获取.该实现是一个基于Python的GAE应用,我们需要下载Google GAE的离线开发包到我们自己的Linux服务器上来运行该项目,搭建大陆互联网环境下的房间服务器。</p>
</li>
<li><p>通话的信令服务器(Signaling Server)</p>
<p>  信令服务器是用来管理和协助通话终端建立去中心的点对点通话的一个角色，主要功能如下，具体协议实现没有严格规定，只要能实现功能就行</p>
<ol>
<li>用来控制通信发起或者结束的连接控制消息</li>
<li>发生错误时用来相互通告的消息</li>
<li>各自一方媒体流元数据，比如像解码器、解码器的配置、带宽、媒体类型等等</li>
<li>两两之间用来建立安全连接的关键数据</li>
<li>外界所能看到的网络上的数据，比如广域网IP地址、端口等</li>
</ol>
</li>
<li><p>防火墙打洞服务器(STUN/TURN/ICE Server)</p>
<p>  我们目前大部分人连接互联网时都处于防火墙后面或者配置私有子网的家庭(NAT)路由器后面,这就导致我们的计算机的IP地址不是广域网IP地址,故而不能相互之间直接通讯. 正因为这样的一个场景,我们得想办法去穿越这些防火墙或者家庭(NAT)路由器,让两个同处于私有网络里的计算机能够通讯起来。<br>  ICE协议是一个offer/answer模型的扩展，是综合TURN和STUN的综合性NAT穿越解决方案，通过在offer和answer的SDP(Session Description Protocol)里面包含多种IP地址和端口，然后对本地SDP和远程SDP里面的IP地址进行配对，然后通过P2P连通性检查进行连通性测试工作，如果测试通过即表明该传输地址对可以建立连接。有兴趣可以去搜索了解一下，这次要安装的ICESever是coTurn，它的功能比较丰富，是一个C/C++语言的开源项目，项目地址: <a href="https://code.google.com/archive/p/coturn/" target="_blank" rel="external">https://code.google.com/archive/p/coturn/</a></p>
</li>
</ul>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>先说一下，楼主系统是ubuntu14.04，内网IP是125.216.242.151，后续很多命令都是基于ubuntu，很多配置中都要用到IP地址，而且需要填写机构或key的时候，楼主都是用的ID：jwcqc，另外，所有的下载或安装都在/server/目录下。</p>
<p>首先需要安装nodejs包管理和分发工具npm：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install npm</div></pre></td></tr></table></figure></p>
<p>其次是安装python-webtest：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install python-webtest</div></pre></td></tr></table></figure></p>
<h3 id="科学上网"><a href="#科学上网" class="headerlink" title="科学上网"></a>科学上网</h3><p>由于安装过程中像Google App Engine和编译安装collider都需要FQ，因此最好提前准备好 FQ 环境，否则安装过程中会遇到网络引起的各种错误。</p>
<p>作为示例，楼主系统是ubuntu14.04，已通过设置http代理实现科学上网，只需编辑 /etc/profile，填入以下三行即可：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">export http_proxy=http://your_proxy.com:port/</div><div class="line">export ftp_proxy=http://your_proxy.com:port/</div><div class="line">export https_proxy=http://your_proxy.com:port/</div></pre></td></tr></table></figure></p>
<p>然后 source /etc/profile 进行保存，可以使用curl www.google.com 测试一下是否设置成功。</p>
<hr>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="房间服务器搭建"><a href="#房间服务器搭建" class="headerlink" title="房间服务器搭建"></a>房间服务器搭建</h3><ol>
<li><p>安装依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install nodejs</div><div class="line">sudo npm install -g npm</div><div class="line">sudo apt-get install nodejs-legacy</div><div class="line">sudo npm -g install grunt-cli</div></pre></td></tr></table></figure>
</li>
<li><p>下载apprtc源码</p>
</li>
</ol>
<p>找到一个目录用来存放源码（楼主下载时最新提交版本是3459f8c1ba69a8011f117de3b46b2f19372e1660），依次执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/webrtc/apprtc.git</div><div class="line">cd apprtc</div><div class="line">npm install  //install grunt and required grunt dependencies</div></pre></td></tr></table></figure></p>
<ol>
<li>修改配置文件</li>
</ol>
<p>接下来需要修改项目中的 /apprtc/src/app_engine/constants.py，修改的部分内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">//turn打洞服务器配置</div><div class="line">TURN_BASE_URL = &apos;https://125.216.242.151&apos;</div><div class="line">TURN_URL_TEMPLATE = &apos;%s/turn?username=%s&amp;key=%s&apos;</div><div class="line">CEOD_KEY = &apos;jwcqc&apos; //主要要与之后turn服务器中的配置一致</div><div class="line">//ICE服务器配置</div><div class="line">ICE_SERVER_BASE_URL = &apos;https://125.216.242.151&apos;</div><div class="line">ICE_SERVER_URL_TEMPLATE = &apos;%s/v1alpha/iceconfig?key=%s&apos;</div><div class="line">ICE_SERVER_API_KEY = os.environ.get(&apos;ICE_SERVER_API_KEY&apos;)</div><div class="line">WSS_INSTANCE_HOST_KEY = &apos;125.216.242.151:8089&apos; //信令服务器配置，这里分配8089端口</div><div class="line">WSS_INSTANCE_NAME_KEY = &apos;vm_name&apos;</div><div class="line">WSS_INSTANCE_ZONE_KEY = &apos;zone&apos;</div><div class="line">WSS_INSTANCES = [&#123;</div><div class="line">  WSS_INSTANCE_HOST_KEY: &apos;125.216.242.151:8089&apos;,</div><div class="line">  WSS_INSTANCE_NAME_KEY: &apos;wsserver-std&apos;,</div><div class="line">  WSS_INSTANCE_ZONE_KEY: &apos;us-central1-a&apos;</div><div class="line">&#125;, &#123;</div><div class="line">  WSS_INSTANCE_HOST_KEY: &apos;125.216.242.151:8089&apos;,</div><div class="line">  WSS_INSTANCE_NAME_KEY: &apos;wsserver-std-2&apos;,</div><div class="line">  WSS_INSTANCE_ZONE_KEY: &apos;us-central1-f&apos;</div><div class="line">&#125;]</div></pre></td></tr></table></figure></p>
<p>修改之后，进入到apprtc根目录，开始build<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grunt build</div></pre></td></tr></table></figure></p>
<p>注意每一次对源代码的修改，都需要重新再编译一次，编译过后，会得到一个out目录，可以进去查看之前的修改是否生效。</p>
<ol>
<li>安装googleappengine</li>
</ol>
<p>运行还依赖 Google App Engine SDK for Python，<a href="https://cloud.google.com/appengine/downloads#Google_App_Engine_SDK_for_Python" target="_blank" rel="external">地址点我</a>（需要FQ），选择一个目录，先后运行如下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">//下载</div><div class="line">wget https://storage.googleapis.com/appengine-sdks/featured/google_appengine_1.9.40.zip</div><div class="line">//解压</div><div class="line">unzip google_appengine_1.9.40.zip</div><div class="line">//设置环境变量</div><div class="line">vim /etc/profile</div><div class="line">//添加进profile</div><div class="line">export PATH=&quot;$PATH:/root/google_appengine/&quot;</div><div class="line">//保存环境变量</div><div class="line">source /etc/profile</div></pre></td></tr></table></figure></p>
<ol>
<li>开启roomserver</li>
</ol>
<p>执行完上面4步后，房间服务器的安装与配置便已完成，接下来就是运行了，进入到google_appengine根目录下，执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo ./dev_appserver.py --host=125.216.242.151 /server/apprtc/out/app_engine //楼主的apprtc位于server目录下</div></pre></td></tr></table></figure></p>
<p>如果嫌运行时间过长，想在后台运行程序，只需用nohup comand &amp;操作即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo nohup ./dev_appserver.py --host=125.216.242.151 /server/apprtc/out/app_engine &amp;</div></pre></td></tr></table></figure></p>
<p>运行完按回车返回前台，nohup以日志形式输出在运行此命令目录下的nohup.out文件</p>
<p>运行成功的话可在浏览器中打开 125.216.242.151:8080 进行访问</p>
<h3 id="信令服务器Collider搭建"><a href="#信令服务器Collider搭建" class="headerlink" title="信令服务器Collider搭建"></a>信令服务器Collider搭建</h3><ol>
<li>安装Go语言运行环境</li>
</ol>
<p>下载地址：<a href="https://golang.org/doc/install?download=go1.7.3.linux-amd64.tar.gz" target="_blank" rel="external">https://golang.org/doc/install?download=go1.7.3.linux-amd64.tar.gz</a><br>下载完成后解压，楼主解压在了/server/目录下，接着再在server目录下创建gopath目录，开始配置go环境：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim /etc/profile</div></pre></td></tr></table></figure></p>
<p>添加以下内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">export GOROOT=/server/go</div><div class="line">export GOPATH=/server/gopath</div><div class="line">export PATH=$PATH:$GOROOT/bin:$GOPATH/bin</div></pre></td></tr></table></figure></p>
<p>使用 source /etc/profile 保存，然后可以运行 go version 查看是否配置正确。</p>
<ol>
<li>拷贝与修改</li>
</ol>
<p>首先拷贝 /apprtc/src/collider 下的三个文件夹到 /server/gopath/src 目录下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cp /server/apprtc/src/collider/collider /server/gopath/src</div><div class="line">cp /server/apprtc/src/collider/collidermain /server/gopath/src</div><div class="line">cp /server/apprtc/src/collider/collidertest /server/gopath/src</div></pre></td></tr></table></figure></p>
<p>修改 /server/gopath/src/collidermain/main.go文件，修改房间服务器IP：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var roomSrv = flag.String(&quot;room-server&quot;, &quot;https://125.216.242.151&quot;, &quot;The origin of the room server&quot;)</div></pre></td></tr></table></figure></p>
<p>再编辑 /server/gopath/src/collidermain/main.gocollider.go 文件，设置信令服务器所需要用的HTTPS的证书文件（证书的创建在第3步，注意目录对应上）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">e = server.ListenAndServeTLS(&quot;/server/cert/jwcqc.crt&quot;, &quot;/server/cert/jwcqc.key&quot;)</div></pre></td></tr></table></figure></p>
<ol>
<li>创建信令服务器证书</li>
</ol>
<p>创建第2步中用到的ssl证书jwcqc.crt和jwcqc.key，本示例的证书创建在/server/cert下，进入到此目录，然后依次执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">openssl genrsa -des3 -out jwcqc.key 2048</div><div class="line">openssl req -new -key jwcqc.key -out jwcqc.csr</div><div class="line">cp jwcqc.key jwcqc.key.org</div><div class="line">openssl rsa -in jwcqc.key.org -out jwcqc.key</div><div class="line">openssl x509 -req -days 365 -in jwcqc.csr -signkey jwcqc.key -out jwcqc.crt</div></pre></td></tr></table></figure></p>
<p>期间会让输入地理位置、机构、密匙等信息，按照提示输入即可，楼主的密码全部设的是：jwcqc</p>
<ol>
<li>编译collider源码</li>
</ol>
<p>进入 /server/gopath 目录，准备编译安装collider（需要FQ）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">go get collidermain</div><div class="line">go install collidermain</div></pre></td></tr></table></figure></p>
<p>成功编译后会在gopath目录下生成bin和pkg目录。</p>
<ol>
<li>运行collider服务器</li>
</ol>
<p>进入 /server/gopath/bin 目录，用如下命令运行collider服务器：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./collidermain -port=8089 -tls=true</div></pre></td></tr></table></figure></p>
<h3 id="coTurn服务器搭建"><a href="#coTurn服务器搭建" class="headerlink" title="coTurn服务器搭建"></a>coTurn服务器搭建</h3><h4 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h4><p>最后一步是安装coTurn打洞服务器，下载地址 <a href="http://turnserver.open-sys.org/downloads/" target="_blank" rel="external">http://turnserver.open-sys.org/downloads/</a> 找到适合自己系统的下载即可，楼主下载的是 <a href="http://turnserver.open-sys.org/downloads/v4.4.5.3/turnserver-4.4.5.3-debian-wheezy-ubuntu-mint-x86-64bits.tar.gz" target="_blank" rel="external">http://turnserver.open-sys.org/downloads/v4.4.5.3/turnserver-4.4.5.3-debian-wheezy-ubuntu-mint-x86-64bits.tar.gz</a></p>
<p>然后解压到 /server/turnserver/下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar -zxvf turnserver-4.4.5.3-debian-wheezy-ubuntu-mint-x86-64bits.tar.gz</div></pre></td></tr></table></figure></p>
<p>解压后会得到INSTALL安装须知和.deb包，可以使用 cat INSTALL 查看一下安装手册，根据指导进行安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install gdebi-core</div><div class="line">sudo gdebi *.deb</div></pre></td></tr></table></figure></p>
<h4 id="生成签名证书"><a href="#生成签名证书" class="headerlink" title="生成签名证书"></a>生成签名证书</h4><p>这里同样生成在了/server/cert/目录下，密码全部是jwcqc：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo openssl req -x509 -newkey  rsa:2048 -keyout /server/cert/turn_server_pkey.pem -out /server/cert/turn_server_cert.pem -days 99999 -nodes</div></pre></td></tr></table></figure></p>
<p>接下来运行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">turnadmin -k -u jwcqc -r north.gov -p jwcqc</div></pre></td></tr></table></figure></p>
<p>拷贝生成得到的key，下一步会用到。</p>
<h4 id="编辑配置文件"><a href="#编辑配置文件" class="headerlink" title="编辑配置文件"></a>编辑配置文件</h4><p>首先编辑 /etc/default/coturn 将 TURNSERVER_ENABLED=1 的注释去掉，<br>再编辑 /etc/turnserver.conf，在末尾加入如下内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">listening-device=eth0</div><div class="line">listening-port=3478</div><div class="line">relay-device=eth0</div><div class="line">min-port=49152</div><div class="line">max-port=65535</div><div class="line">Verbose</div><div class="line">fingerprint</div><div class="line">lt-cred-mech</div><div class="line">use-auth-secret</div><div class="line">static-auth-secret=jwcqc</div><div class="line">user=jwcqc:0x949534a397bcf2e88470c86ad3749d9c（替换成上一步通过turnadmin生成的key）</div><div class="line">user=jwcqc:jwcqc</div><div class="line">stale-nonce</div><div class="line">cert=/server/cert/turn_server_cert.pem</div><div class="line">pkey=/server/cert/turn_server_pkey.pem</div><div class="line">no-loopback-peers</div><div class="line">no-multicast-peers</div><div class="line">mobility</div><div class="line">no-cli</div></pre></td></tr></table></figure></p>
<p>最后一步，进入/apprtc/src/web_app/js/utils.js，修改requestIceServers函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">function requestIceServers(iceServerRequestUrl, iceTransports) &#123;</div><div class="line">  return new Promise(function(resolve, reject) &#123;</div><div class="line">    var servers = [&#123;</div><div class="line">        credential: &quot;jwcqc&quot;,</div><div class="line">        username: &quot;jwcqc&quot;,</div><div class="line">        urls: [</div><div class="line">          &quot;turn:125.216.242.151:3478?transport=udp&quot;,</div><div class="line">          &quot;turn:125.216.242.151:3478?transport=tcp&quot;</div><div class="line">        ]</div><div class="line">    &#125;];</div><div class="line">    resolve(servers);</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由于修改了代码，因此需要进入apprtc目录下执行 grunt build 重新编译。</p>
<h4 id="启动coturn服务器"><a href="#启动coturn服务器" class="headerlink" title="启动coturn服务器"></a>启动coturn服务器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service coturn start</div></pre></td></tr></table></figure>
<p>至此，三个服务器便已全部搭建完成并启动，接下来要做的，就是安装并配置Nginx反向代理服务器，提供默认HTTPS的访问。</p>
<h2 id="Nginx服务器安装与配置"><a href="#Nginx服务器安装与配置" class="headerlink" title="Nginx服务器安装与配置"></a>Nginx服务器安装与配置</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>这里采用在线安装的方式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install nginx</div></pre></td></tr></table></figure></p>
<p>所有的配置文件都在/etc/nginx下，并且每个虚拟主机已经安排在了/etc/nginx/sites-available下，启动程序文件在/usr/sbin/nginx，日志放在了/var/log/nginx中，分别是access.log和error.log，并已经在/etc/init.d/下创建了启动脚本nginx，默认的虚拟主机的目录设置在了/usr/share/nginx/www。</p>
<p>也可以采用源代码安装方式，下载地址 <a href="http://nginx.org/download/" target="_blank" rel="external">http://nginx.org/download/</a> 下载过后解压缩，再进入到解压后的文件夹，先后执行./configure指令，再 make，再 make install 即安装完成，安装成功之后，nginx放置在/usr/local/nginx目录下，主要的配置文件为conf目录下的nginx.conf，nginx的启动文件在sbin目录下的nginx文件。</p>
<p>接下来修改配置文件：vim /etc/nginx/sites-enabled/local<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">upstream roomserver &#123;</div><div class="line">        server 125.216.242.151:8080;</div><div class="line">&#125;</div><div class="line">server &#123;</div><div class="line">        listen 80 ;</div><div class="line">        server_name 125.216.242.151;</div><div class="line">        return  301 https://$server_name$request_uri;</div><div class="line">&#125;</div><div class="line">server &#123;</div><div class="line">        root /usr/share/nginx/html;</div><div class="line">        index index.php index.html index.htm;</div><div class="line">        listen 443 ;</div><div class="line">        ssl on;</div><div class="line">        ssl_certificate      /server/cert/jwcqc.crt;</div><div class="line">        ssl_certificate_key  /server/cert/jwcqc.key;</div><div class="line">        server_name 125.216.242.151;</div><div class="line">        access_log  /var/log/nginx/jwcqc.log;</div><div class="line">        location / &#123;</div><div class="line">               proxy_pass http://roomserver$request_uri;</div><div class="line">               proxy_set_header Host $host;</div><div class="line">        &#125;</div><div class="line">        location ~ .php$ &#123;</div><div class="line">        fastcgi_pass unix:/var/run/php5-fpm.sock;</div><div class="line">        fastcgi_index index.php;</div><div class="line">        include fastcgi_params;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="启动Nginx"><a href="#启动Nginx" class="headerlink" title="启动Nginx"></a>启动Nginx</h3><p>在线安装的启动过程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo /etc/init.d/nginx start</div></pre></td></tr></table></figure></p>
<p>源代码安装的启动过程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd /usr/local/nginx</div><div class="line">sbin/nginx</div></pre></td></tr></table></figure></p>
<p>然后就可以通过 <a href="http://localhost" target="_blank" rel="external">http://localhost</a> 进行访问了，默认是80端口</p>
<hr>
<p>最后，终于！！！ 打开一个谷歌浏览器，访问 <a href="http://125.216.242.151" target="_blank" rel="external">http://125.216.242.151</a> ，选择默认随机生成的房间号或自己手动输入房间号，即可以多台电脑进入这个房间进行测试了。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://jwcqc.me/2016/09/26/apprtc-server-build-process/" data-id="cixsjbasu0004dsv8zec0a2g9" class="article-share-link">分享到</a><div class="tags"><a href="/tags/WebRTC/">WebRTC</a></div><div class="post-nav"><a href="/2016/10/11/mqtt-redis-achieve-single-account-login/" class="pre">使用MQTT协议+Redis缓存实现APP登录顶号功能</a><a href="/2016/08/18/vmware-network-configuration/" class="next">VMWare虚拟机网络配置</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://jwcqc.me"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/WebView/" style="font-size: 15px;">WebView</a> <a href="/tags/WebRTC/" style="font-size: 15px;">WebRTC</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/10/11/mqtt-redis-achieve-single-account-login/">使用MQTT协议+Redis缓存实现APP登录顶号功能</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/26/apprtc-server-build-process/">AppRTC服务器搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/18/vmware-network-configuration/">VMWare虚拟机网络配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/31/android-webview-performance-monitor/">Android WebView 页面性能监控实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/21/android-webview-development-notes/">Android WebView 开发使用笔记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://i-test.com.cn/" title="用户行为分析平台" target="_blank">用户行为分析平台</a><ul></ul><a href="https://i-test.com.cn/" title="WebRTC使用" target="_blank">WebRTC使用</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">jwcqc个人笔记.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>